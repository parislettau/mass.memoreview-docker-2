!function(e,t){"function"==typeof define&&define.amd?define(["jquery"],function(r){return e.Intercooler=t(r)}):"object"==typeof module&&module.exports?module.exports=t(require("jquery")):e.Intercooler=t(e.jQuery)}(this,function($){var Intercooler=Intercooler||function(){"use strict";function remove(e){e.remove()}function showIndicator(e){e.closest(".ic-use-transition").length>0?(e.data("ic-use-transition",!0),e.removeClass("ic-use-transition")):e.show()}function hideIndicator(e){e.data("ic-use-transition")||e.data("ic-indicator-cleared")?(e.data("ic-use-transition",null),e.addClass("ic-use-transition"),e.data("ic-indicator-cleared",!0)):e.hide()}function fixICAttributeName(e){return USE_DATA?"data-"+e:e}function getICAttribute(e,t){return e.attr(fixICAttributeName(t))}function setICAttribute(e,t,r){e.attr(fixICAttributeName(t),r)}function prepend(e,t){try{e.prepend(t)}catch(t){log(e,formatError(t),"ERROR")}if(getICAttribute(e,"ic-limit-children")){var r=parseInt(getICAttribute(e,"ic-limit-children"));e.children().length>r&&e.children().slice(r,e.children().length).remove()}}function append(e,t){try{e.append(t)}catch(t){log(e,formatError(t),"ERROR")}if(getICAttribute(e,"ic-limit-children")){var r=parseInt(getICAttribute(e,"ic-limit-children"));e.children().length>r&&e.children().slice(0,e.children().length-r).remove()}}function triggerEvent(e,t,r){$.zepto&&(t=t.split(".").reverse().join(":")),e.trigger(t,r)}function log(e,t,r){if(null==e&&(e=$("body")),triggerEvent(e,"log.ic",[t,r,e]),"ERROR"==r){window.console&&window.console.log("Intercooler Error : "+t);var n=closestAttrValue($("body"),"ic-post-errors-to");n&&$.post(n,{error:t})}}function uuid(){return _UUID++}function icSelectorFor(e){return getICAttributeSelector("ic-id='"+getIntercoolerId(e)+"'")}function parseInterval(e){return log(null,"POLL: Parsing interval string "+e,"DEBUG"),"null"==e||"false"==e||""==e?null:e.lastIndexOf("ms")==e.length-2?parseFloat(e.substr(0,e.length-2)):e.lastIndexOf("s")==e.length-1?1e3*parseFloat(e.substr(0,e.length-1)):1e3}function getICAttributeSelector(e){return"["+fixICAttributeName(e)+"]"}function initScrollHandler(){null==_scrollHandler&&(_scrollHandler=function(){$(getICAttributeSelector("ic-trigger-on='scrolled-into-view'")).each(function(){var e=$(this);isScrolledIntoView(getTriggeredElement(e))&&1!=e.data("ic-scrolled-into-view-loaded")&&(e.data("ic-scrolled-into-view-loaded",!0),fireICRequest(e))})},$(window).scroll(_scrollHandler))}function currentUrl(){return window.location.pathname+window.location.search+window.location.hash}function createDocument(e){var t=null;return/<(html|body)/i.test(e)?(t=document.documentElement.cloneNode()).innerHTML=e:(t=document.documentElement.cloneNode(!0)).querySelector("body").innerHTML=e,$(t)}function getTarget(e){return getTargetImpl(e,"ic-target")}function getTargetImpl(e,t){var r=$(e).closest(getICAttributeSelector(t)),n=getICAttribute(r,t);return"this"==n?r:n&&0!=n.indexOf("this.")?0==n.indexOf("closest ")?e.closest(n.substr(8)):0==n.indexOf("find ")?e.find(n.substr(5)):$(n):e}function processHeaders(e,t){triggerEvent(e=$(e),"beforeHeaders.ic",[e,t]),log(e,"response headers: "+t.getAllResponseHeaders(),"DEBUG");var r=null;if(t.getResponseHeader("X-IC-Title")&&(document.title=t.getResponseHeader("X-IC-Title")),t.getResponseHeader("X-IC-Title-Encoded")){var n=decodeURIComponent(t.getResponseHeader("X-IC-Title-Encoded").replace(/\+/g,"%20"));document.title=n}if(t.getResponseHeader("X-IC-Refresh")){var i=t.getResponseHeader("X-IC-Refresh").split(",");log(e,"X-IC-Refresh: refreshing "+i,"DEBUG"),$.each(i,function(t,r){refreshDependencies(r.replace(/ /g,""),e)})}if(t.getResponseHeader("X-IC-Script")&&(log(e,"X-IC-Script: evaling "+t.getResponseHeader("X-IC-Script"),"DEBUG"),globalEval(t.getResponseHeader("X-IC-Script"),[["elt",e]])),t.getResponseHeader("X-IC-Redirect")&&(log(e,"X-IC-Redirect: redirecting to "+t.getResponseHeader("X-IC-Redirect"),"DEBUG"),window.location=t.getResponseHeader("X-IC-Redirect")),"true"==t.getResponseHeader("X-IC-CancelPolling")&&cancelPolling(e.closest(getICAttributeSelector("ic-poll"))),"true"==t.getResponseHeader("X-IC-ResumePolling")){setICAttribute(o=e.closest(getICAttributeSelector("ic-poll")),"ic-pause-polling",null),startPolling(o)}if(t.getResponseHeader("X-IC-SetPollInterval")){var o;cancelPolling(o=e.closest(getICAttributeSelector("ic-poll"))),setICAttribute(o,"ic-poll",t.getResponseHeader("X-IC-SetPollInterval")),startPolling(o)}t.getResponseHeader("X-IC-Open")&&(log(e,"X-IC-Open: opening "+t.getResponseHeader("X-IC-Open"),"DEBUG"),window.open(t.getResponseHeader("X-IC-Open")));var s=t.getResponseHeader("X-IC-Trigger");if(s)if(log(e,"X-IC-Trigger: found trigger "+s,"DEBUG"),r=getTarget(e),t.getResponseHeader("X-IC-Trigger-Data")){var c=$.parseJSON(t.getResponseHeader("X-IC-Trigger-Data"));triggerEvent(r,s,c)}else s.indexOf("{")>=0?$.each($.parseJSON(s),function(e,t){triggerEvent(r,e,t)}):triggerEvent(r,s,[]);var a=t.getResponseHeader("X-IC-Set-Local-Vars");if(a&&$.each($.parseJSON(a),function(e,t){localStorage.setItem(e,t)}),t.getResponseHeader("X-IC-Remove")&&e){var l=t.getResponseHeader("X-IC-Remove"),u=parseInterval(l+="");log(e,"X-IC-Remove header found.","DEBUG"),r=getTarget(e),"true"==l||null==u?remove(r):(r.addClass("ic-removing"),setTimeout(function(){remove(r)},u))}return triggerEvent(e,"afterHeaders.ic",[e,t]),!0}function beforeRequest(e){e.addClass("disabled"),e.addClass("ic-request-in-flight"),e.data("ic-request-in-flight",!0)}function requestCleanup(e,t,r){e.length>0&&hideIndicator(e),t.length>0&&hideIndicator(t),r.removeClass("disabled"),r.removeClass("ic-request-in-flight"),r.data("ic-request-in-flight",!1),r.data("ic-next-request")&&(r.data("ic-next-request").req(),r.data("ic-next-request",null))}function replaceOrAddMethod(e,t){if("string"===$.type(e)){var r=/(&|^)_method=[^&]*/,n="&_method="+t;return r.test(e)?e.replace(r,n):e+n}return e.append("_method",t),e}function isIdentifier(e){return/^[$A-Z_][0-9A-Z_$]*$/i.test(e)}function globalEval(e,t){var r=[],n=[];if(t)for(var i=0;i<t.length;i++)r.push(t[i][0]),n.push(t[i][1]);if(isIdentifier(e))return window[e].apply(this,n);return window.eval.call(window,"(function ("+r.join(", ")+") {"+e+"})").apply(this,n)}function closestAttrValue(e,t){var r=$(e).closest(getICAttributeSelector(t));return r.length>0?getICAttribute(r,t):null}function formatError(e){var t=e.toString()+"\n";try{t+=e.stack}catch(e){}return t}function getLocalURL(e,t,r){if(t){e+="?";var n={};r.replace(/([^=&]+)=([^&]*)/gi,function(e,t,r){n[t]=r}),$(t.split(",")).each(function(t){var r=$.trim(this),i=n[r]||"";e+=0==t?"":"&",e+=r+"="+i})}return e}function handleRemoteRequest(e,t,r,n,i){beforeRequest(e),n=replaceOrAddMethod(n,t);var o=findGlobalIndicator(e);o&&o.length>0&&showIndicator(o);var s=findIndicator(e);s.length>0&&showIndicator(s);var c=uuid(),a=new Date,l={type:USE_ACTUAL_HTTP_METHOD?t:"GET"==t?"GET":"POST",url:r,data:n,dataType:"text",headers:{Accept:"text/html-partial, */*; q=0.9","X-IC-Request":!0,"X-HTTP-Method-Override":t},beforeSend:function(i,o){triggerEvent(e,"beforeSend.ic",[e,n,o,i,c]),log(e,"before AJAX request "+c+": "+t+" to "+r,"DEBUG");var s=closestAttrValue(e,"ic-on-beforeSend");s&&globalEval(s,[["elt",e],["data",n],["settings",o],["xhr",i]]),maybeInvokeLocalAction(e,"-beforeSend")},success:function(t,r,a){triggerEvent(e,"success.ic",[e,t,r,a,c]),log(e,"AJAX request "+c+" was successful.","DEBUG");var l=closestAttrValue(e,"ic-on-success");if(!l||0!=globalEval(l,[["elt",e],["data",t],["textStatus",r],["xhr",a]])){var u=new Date,d=document.title;try{if(processHeaders(e,a)){log(e,"Processed headers for request "+c+" in "+(new Date-u)+"ms","DEBUG");var f=new Date;if(a.getResponseHeader("X-IC-PushURL")||"true"==closestAttrValue(e,"ic-push-url"))try{requestCleanup(s,o,e);var g=closestAttrValue(e,"ic-src"),p=closestAttrValue(e,"ic-push-params"),h=a.getResponseHeader("X-IC-PushURL")||getLocalURL(g,p,n);if(!_history)throw"History support not enabled";_history.snapshotForHistory(h,d)}catch(t){log(e,"Error during history snapshot for "+c+": "+formatError(t),"ERROR")}i(t,r,e,a),log(e,"Process content for request "+c+" in "+(new Date-f)+"ms","DEBUG")}triggerEvent(e,"after.success.ic",[e,t,r,a,c]),maybeInvokeLocalAction(e,"-success")}catch(t){log(e,"Error processing successful request "+c+" : "+formatError(t),"ERROR")}}},error:function(t,n,i){triggerEvent(e,"error.ic",[e,n,i,t]);var o=closestAttrValue(e,"ic-on-error");o&&globalEval(o,[["elt",e],["status",n],["str",i],["xhr",t]]),processHeaders(e,t),maybeInvokeLocalAction(e,"-error"),log(e,"AJAX request "+c+" to "+r+" experienced an error: "+i,"ERROR")},complete:function(t,r){log(e,"AJAX request "+c+" completed in "+(new Date-a)+"ms","DEBUG"),requestCleanup(s,o,e);try{$.contains(document,e[0])?triggerEvent(e,"complete.ic",[e,n,r,t,c]):triggerEvent($("body"),"complete.ic",[e,n,r,t,c])}catch(t){log(e,"Error during complete.ic event for "+c+" : "+formatError(t),"ERROR")}var i=closestAttrValue(e,"ic-on-complete");i&&globalEval(i,[["elt",e],["xhr",t],["status",r]]),maybeInvokeLocalAction(e,"-complete")}};"string"!=$.type(n)&&(l.dataType=null,l.processData=!1,l.contentType=!1),triggerEvent($(document),"beforeAjaxSend.ic",[l,e]),l.cancel?requestCleanup(s,o,e):$.ajax(l)}function findGlobalIndicator(e){var t=$([]),r=closestAttrValue(e=$(e),"ic-global-indicator");return r&&"false"!==r&&(t=$(r).first()),t}function findIndicator(e){var t=$([]);if(e=$(e),getICAttribute(e,"ic-indicator"))t=$(getICAttribute(e,"ic-indicator")).first();else if(0==(t=e.find(".ic-indicator").first()).length){var r=closestAttrValue(e,"ic-indicator");r?t=$(r).first():e.next().is(".ic-indicator")&&(t=e.next())}return t}function processIncludes(e,t){if(0==$.trim(t).indexOf("{")){var r=$.parseJSON(t);$.each(r,function(t,r){e=appendData(e,t,r)})}else $(t).each(function(){var t=$(this).serializeArray();$.each(t,function(t,r){e=appendData(e,r.name,r.value)})});return e}function processLocalVars(e,t){return $(t.split(",")).each(function(){var t=$.trim(this),r=localStorage.getItem(t);r&&(e=appendData(e,t,r))}),e}function appendData(e,t,r){return"string"===$.type(e)?("string"!==$.type(r)&&(r=JSON.stringify(r)),e+"&"+t+"="+encodeURIComponent(r)):(e.append(t,r),e)}function getParametersForElement(e,t,r){var n=getTarget(t),i=null;if(t.is("form")&&"multipart/form-data"==t.attr("enctype"))i=appendData(i=new FormData(t[0]),"ic-request",!0);else{i="ic-request=true";var o=t.closest("form");if(t.is("form")||"GET"!=e&&o.length>0){i+="&"+o.serialize();var s=t.data("ic-last-clicked-button");s&&(i=appendData(i,s.name,s.value))}else i+="&"+t.serialize()}var c=closestAttrValue(t,"ic-prompt");if(c){var a=prompt(c);if(!a)return null;var l=closestAttrValue(t,"ic-prompt-name")||"ic-prompt-value";i=appendData(i,l,a)}t.attr("id")&&(i=appendData(i,"ic-element-id",t.attr("id"))),t.attr("name")&&(i=appendData(i,"ic-element-name",t.attr("name"))),getICAttribute(n,"ic-id")&&(i=appendData(i,"ic-id",getICAttribute(n,"ic-id"))),n.attr("id")&&(i=appendData(i,"ic-target-id",n.attr("id"))),r&&r.attr("id")&&(i=appendData(i,"ic-trigger-id",r.attr("id"))),r&&r.attr("name")&&(i=appendData(i,"ic-trigger-name",r.attr("name")));var u=closestAttrValue(t,"ic-include");u&&(i=processIncludes(i,u));var d=closestAttrValue(t,"ic-local-vars");d&&(i=processLocalVars(i,d)),$(getICAttributeSelector("ic-global-include")).each(function(){i=processIncludes(i,getICAttribute($(this),"ic-global-include"))}),i=appendData(i,"ic-current-url",currentUrl());var f=closestAttrValue(t,"ic-select-from-response");return f&&(i=appendData(i,"ic-select-from-response",f)),log(t,"request parameters "+i,"DEBUG"),i}function maybeSetIntercoolerInfo(e){getIntercoolerId(getTarget(e)),1!=e.data("elementAdded.ic")&&(e.data("elementAdded.ic",!0),triggerEvent(e,"elementAdded.ic"))}function getIntercoolerId(e){return getICAttribute(e,"ic-id")||setICAttribute(e,"ic-id",uuid()),getICAttribute(e,"ic-id")}function processNodes(e){(e=$(e)).length>1?e.each(function(){processNodes(this)}):(processMacros(e),processEnhancement(e),processSources(e),processPolling(e),processEventSources(e),processTriggerOn(e),processRemoveAfter(e),processAddClasses(e),processRemoveClasses(e))}function fireReadyStuff(e){triggerEvent(e,"nodesProcessed.ic"),$.each(_readyHandlers,function(t,r){try{r(e)}catch(t){log(e,formatError(t),"ERROR")}})}function autoFocus(e){e.find("[autofocus]").last().focus()}function processMacros(e){$.each(_MACROS,function(t,r){0==e.closest(".ic-ignore").length&&(e.is("["+r+"]")&&processMacro(r,e),e.find("["+r+"]").each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&processMacro(r,e)}))})}function processSources(e){0==e.closest(".ic-ignore").length&&(e.is(getICAttributeSelector("ic-src"))&&maybeSetIntercoolerInfo(e),e.find(getICAttributeSelector("ic-src")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&maybeSetIntercoolerInfo(e)}))}function processPolling(e){0==e.closest(".ic-ignore").length&&(e.is(getICAttributeSelector("ic-poll"))&&(maybeSetIntercoolerInfo(e),startPolling(e)),e.find(getICAttributeSelector("ic-poll")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&(maybeSetIntercoolerInfo(e),startPolling(e))}))}function processTriggerOn(e){0==e.closest(".ic-ignore").length&&(handleTriggerOn(e),e.find(getICAttributeSelector("ic-trigger-on")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleTriggerOn(e)}))}function processRemoveAfter(e){0==e.closest(".ic-ignore").length&&(handleRemoveAfter(e),e.find(getICAttributeSelector("ic-remove-after")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleRemoveAfter(e)}))}function processAddClasses(e){0==e.closest(".ic-ignore").length&&(handleAddClasses(e),e.find(getICAttributeSelector("ic-add-class")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleAddClasses(e)}))}function processRemoveClasses(e){0==e.closest(".ic-ignore").length&&(handleRemoveClasses(e),e.find(getICAttributeSelector("ic-remove-class")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleRemoveClasses(e)}))}function processEnhancement(e){0==e.closest(".ic-ignore").length&&("true"===closestAttrValue(e,"ic-enhance")?enhanceDomTree(e):e.find(getICAttributeSelector("ic-enhance")).each(function(){enhanceDomTree($(this))}))}function processEventSources(e){0==e.closest(".ic-ignore").length&&(handleEventSource(e),e.find(getICAttributeSelector("ic-sse-src")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleEventSource(e)}))}function startPolling(e){if(null==e.data("ic-poll-interval-id")&&"true"!=getICAttribute(e,"ic-pause-polling")){var t=parseInterval(getICAttribute(e,"ic-poll"));if(null!=t){var r=icSelectorFor(e),n=parseInt(getICAttribute(e,"ic-poll-repeats"))||-1,i=0;log(e,"POLL: Starting poll for element "+r,"DEBUG");var o=setInterval(function(){var t=$(r);triggerEvent(e,"onPoll.ic",t),0==t.length||i==n||e.data("ic-poll-interval-id")!=o?(log(e,"POLL: Clearing poll for element "+r,"DEBUG"),clearTimeout(o)):fireICRequest(t),i++},t);e.data("ic-poll-interval-id",o)}}}function cancelPolling(e){null!=e.data("ic-poll-interval-id")&&(clearTimeout(e.data("ic-poll-interval-id")),e.data("ic-poll-interval-id",null))}function refreshDependencies(e,t){log(t,"refreshing dependencies for path "+e,"DEBUG"),$(getICAttributeSelector("ic-src")).each(function(){var r=!1,n=$(this);"GET"==verbFor(n)&&"ignore"!=getICAttribute(n,"ic-deps")&&(isDependent(e,getICAttribute(n,"ic-src"))?null!=t&&$(t)[0]==n[0]||(fireICRequest(n),r=!0):(isICDepsDependent(e,getICAttribute(n,"ic-deps"))||"*"==getICAttribute(n,"ic-deps"))&&(null!=t&&$(t)[0]==n[0]||(fireICRequest(n),r=!0))),r&&log(n,"depends on path "+e+", refreshing...","DEBUG")})}function isICDepsDependent(e,t){if(t)for(var r=t.split(","),n=0;n<r.length;n++){if(isDependent(e,r[n].trim()))return!0}return!1}function isDependent(e,t){return!!_isDependentFunction(e,t)}function verbFor(e){return e=$(e),getICAttribute(e,"ic-verb")?getICAttribute(e,"ic-verb").toUpperCase():"GET"}function eventFor(e,t){return"default"==e?(t=$(t)).is("button")?"click":t.is("form")?"submit":t.is("input, textarea, select, button")?"change":"click":e}function preventDefault(e,t){return e.is("form")||e.is('input[type="submit"], button')&&1==e.closest("form").length||e.is("a")&&e.is("[href]")&&0!=e.attr("href").indexOf("#")}function handleRemoveAfter(e){if(e=$(e),getICAttribute(e,"ic-remove-after")){var t=parseInterval(getICAttribute(e,"ic-remove-after"));setTimeout(function(){remove(e)},t)}}function parseAndApplyClass(e,t,r){var n="",i=50;if(e.indexOf(":")>0){var o=e.split(":");n=o[0],i=parseInterval(o[1])}else n=e;setTimeout(function(){t[r](n)},i)}function handleAddClasses(e){if(e=$(e),getICAttribute(e,"ic-add-class"))for(var t=getICAttribute(e,"ic-add-class").split(","),r=t.length,n=0;n<r;n++)parseAndApplyClass($.trim(t[n]),e,"addClass")}function handleRemoveClasses(e){if(e=$(e),getICAttribute(e,"ic-remove-class"))for(var t=getICAttribute(e,"ic-remove-class").split(","),r=t.length,n=0;n<r;n++)parseAndApplyClass($.trim(t[n]),e,"removeClass")}function handleEventSource(e){if(e=$(e),getICAttribute(e,"ic-sse-src")){var t=initEventSource(e,getICAttribute(e,"ic-sse-src"),"true"===getICAttribute(e,"ic-sse-with-credentials"));e.data("ic-event-sse-source",t),e.data("ic-event-sse-map",{})}}function initEventSource(e,t,r){var n=Intercooler._internal.initEventSource(t,r);return n.onmessage=function(t){processICResponse(t.data,e,!1)},n}function registerSSE(e,t){var r=e.data("ic-event-sse-source"),n=e.data("ic-event-sse-map");r.addEventListener&&1!=n[t]&&r.addEventListener(t,function(){e.find(getICAttributeSelector("ic-trigger-on")).each(function(){var e=$(this);e.attr("ic-trigger-on")=="sse:"+t&&fireICRequest(e)})})}function getTriggeredElement(e){var t=getICAttribute(e,"ic-trigger-from");return t?$("document"==t?document:"window"==t?window:t):e}function handleTriggerOn(e){var t=getICAttribute(e,"ic-trigger-on");if(t){e.is("form")&&e.on("click focus","input, button, select, textarea",function(t){$(this).is('input[type="submit"], button')&&$(this).is("[name]")?e.data("ic-last-clicked-button",{name:$(this).attr("name"),value:$(this).val()}):e.data("ic-last-clicked-button",null)});for(var r=t.split(","),n=0;n<r.length;n++){var i=$.trim(r[n]),o=i.split(" "),s=eventFor(o[0],$(e)),c=o[1];if("load"==i)fireICRequest(e);else if("scrolled-into-view"==i)initScrollHandler(),setTimeout(function(){triggerEvent($(window),"scroll")},100);else if(0==s.indexOf("sse:")){var a=e.closest(getICAttributeSelector("ic-sse-src"));a.length>0&&registerSSE(a,o[0].substr(4))}else if($(getTriggeredElement(e)).on(s,function(t){var r=closestAttrValue(e,"ic-on-beforeTrigger");if(r&&0==globalEval(r,[["elt",e],["evt",t],["elt",e]]))return log(e,"ic-trigger cancelled by ic-on-beforeTrigger","DEBUG"),!1;if("changed"==c){var n=e.val(),i=e.data("ic-previous-val");e.data("ic-previous-val",n),n!=i&&fireICRequest(e)}else if("once"==c){var o=e.data("ic-already-triggered");e.data("ic-already-triggered",!0),!0!==o&&fireICRequest(e)}else fireICRequest(e);return!preventDefault(e)||(t.preventDefault(),!1)}),s&&0==s.indexOf("timeout:")){var l=parseInterval(s.split(":")[1]);setTimeout(function(){$(getTriggeredElement(e)).trigger(s)},l)}}}}function macroIs(e,t){return e==fixICAttributeName(t)}function processMacro(e,t){macroIs(e,"ic-post-to")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-post-to")),setIfAbsent(t,"ic-verb","POST"),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-put-to")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-put-to")),setIfAbsent(t,"ic-verb","PUT"),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-patch-to")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-patch-to")),setIfAbsent(t,"ic-verb","PATCH"),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-get-from")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-get-from")),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-delete-from")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-delete-from")),setIfAbsent(t,"ic-verb","DELETE"),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-action")&&setIfAbsent(t,"ic-trigger-on","default");var r=null;if(macroIs(e,"ic-style-src")){var n=(r=getICAttribute(t,"ic-style-src").split(":"))[0];setIfAbsent(t,"ic-src",r[1]),setIfAbsent(t,"ic-target","this.style."+n)}if(macroIs(e,"ic-attr-src")){var i=(r=getICAttribute(t,"ic-attr-src").split(":"))[0];setIfAbsent(t,"ic-src",r[1]),setIfAbsent(t,"ic-target","this."+i)}macroIs(e,"ic-prepend-from")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-prepend-from")),setIfAbsent(t,"ic-swap-style","prepend")),macroIs(e,"ic-append-from")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-append-from")),setIfAbsent(t,"ic-swap-style","append"))}function isLocalLink(e){return location.hostname===e[0].hostname&&e.attr("href")&&!e.attr("href").startsWith("#")}function enhanceAnchor(e){"true"===closestAttrValue(e,"ic-enhance")&&isLocalLink(e)&&(setIfAbsent(e,"ic-src",e.attr("href")),setIfAbsent(e,"ic-trigger-on","default"),setIfAbsent(e,"ic-deps","ignore"),setIfAbsent(e,"ic-push-url","true"))}function determineFormVerb(e){return e.find('input[name="_method"]').val()||e.attr("method")||e[0].method}function enhanceForm(e){"true"===closestAttrValue(e,"ic-enhance")&&(setIfAbsent(e,"ic-src",e.attr("action")),setIfAbsent(e,"ic-trigger-on","default"),setIfAbsent(e,"ic-deps","ignore"),setIfAbsent(e,"ic-verb",determineFormVerb(e)))}function enhanceDomTree(e){e.is("a")&&enhanceAnchor(e),e.find("a").each(function(){enhanceAnchor($(this))}),e.is("form")&&enhanceForm(e),e.find("form").each(function(){enhanceForm($(this))})}function setIfAbsent(e,t,r){null==getICAttribute(e,t)&&setICAttribute(e,t,r)}function isScrolledIntoView(e){if(0==(e=$(e)).height()&&0==e.width())return!1;var t=$(window).scrollTop(),r=t+$(window).height(),n=e.offset().top,i=n+e.height();return i>=t&&n<=r&&i<=r&&n>=t}function maybeScrollToTarget(e,t){if("false"!=closestAttrValue(e,"ic-scroll-to-target")&&("true"==closestAttrValue(e,"ic-scroll-to-target")||"true"==closestAttrValue(t,"ic-scroll-to-target"))){var r=-50;closestAttrValue(e,"ic-scroll-offset")?r=parseInt(closestAttrValue(e,"ic-scroll-offset")):closestAttrValue(t,"ic-scroll-offset")&&(r=parseInt(closestAttrValue(t,"ic-scroll-offset")));var n=t.offset().top,i=$(window).scrollTop(),o=i+window.innerHeight;(n<i||n>o)&&(r+=n,$("html,body").animate({scrollTop:r},400))}}function getTransitionDuration(e,t){var r=closestAttrValue(e,"ic-transition-duration");if(r)return parseInterval(r);if(r=closestAttrValue(t,"ic-transition-duration"))return parseInterval(r);var n=0,i=(t=$(t)).css("transition-duration");i&&(n+=parseInterval(i));var o=t.css("transition-delay");return o&&(n+=parseInterval(o)),n}function closeSSESource(e){var t=e.data("ic-event-sse-source");try{t&&t.close()}catch(t){log(e,"Error closing ServerSentEvent source"+t,"ERROR")}}function beforeSwapCleanup(e){e.find(getICAttributeSelector("ic-sse-src")).each(function(){closeSSESource($(this))}),triggerEvent(e,"beforeSwap.ic")}function processICResponse(e,t,r,n){if(e&&""!=e&&" "!=e){log(t,"response content: \n"+e,"DEBUG");var i=getTarget(t),o=closestAttrValue(t,"ic-transform-response");o&&(e=globalEval(o,[["content",e],["url",n],["elt",t]]));var s=maybeFilter(e,closestAttrValue(t,"ic-select-from-response"));"true"==closestAttrValue(t,"ic-fix-ids")&&fixIDs(s);if(0==i.length)return void log(t,"Invalid target for element: "+getICAttribute(t.closest(getICAttributeSelector("ic-target")),"ic-target"),"ERROR");var c=getTransitionDuration(t,i);i.addClass("ic-transitioning"),setTimeout(function(){try{!function(){if("true"==closestAttrValue(t,"ic-replace-target")){try{beforeSwapCleanup(i),closeSSESource(i),i.replaceWith(s),i=s}catch(e){log(t,formatError(e),"ERROR")}processNodes(s),fireReadyStuff(i),autoFocus(i)}else{if("prepend"==getICAttribute(t,"ic-swap-style"))prepend(i,s),processNodes(s),fireReadyStuff(i),autoFocus(i);else if("append"==getICAttribute(t,"ic-swap-style"))append(i,s),processNodes(s),fireReadyStuff(i),autoFocus(i);else{try{beforeSwapCleanup(i),i.empty().append(s)}catch(e){log(t,formatError(e),"ERROR")}i.children().each(function(){processNodes(this)}),fireReadyStuff(i),autoFocus(i)}1!=r&&maybeScrollToTarget(t,i);var e=t.closest(getICAttributeSelector("ic-switch-class")),n=e.attr(fixICAttributeName("ic-switch-class"));n&&(e.children().removeClass(n),e.children().each(function(){($.contains($(this)[0],$(t)[0])||$(this)[0]==$(t)[0])&&($(this).addClass(n),$(this).addClass(n))}))}}()}catch(e){log(t,"Error during content swap : "+formatError(e),"ERROR")}setTimeout(function(){try{i.removeClass("ic-transitioning"),_history&&_history.updateHistory(),triggerEvent(i,"complete_transition.ic",[i])}catch(e){log(t,"Error during transition complete : "+formatError(e),"ERROR")}},20)},c)}else log(t,"Empty response, nothing to do here.","DEBUG")}function maybeFilter(e,t){var r;if($.zepto){var n=createDocument(e);r=$(n).find("body").contents()}else r=$($.parseHTML(e,null,!0));return t?walkTree(r,t).contents():r}function walkTree(e,t){return e.filter(t).add(e.find(t))}function fixIDs(e){var t={};walkTree(e,"[id]").each(function(){var e,r=$(this).attr("id");do{e="ic-fixed-id-"+uuid()}while($("#"+e).length>0);t[r]=e,$(this).attr("id",e)}),walkTree(e,"label[for]").each(function(){var e=$(this).attr("for");$(this).attr("for",t[e]||e)}),walkTree(e,"*").each(function(){$.each(this.attributes,function(){-1!==this.value.indexOf("#")&&(this.value=this.value.replace(/#([-_A-Za-z0-9]+)/g,function(e,r){return"#"+(t[r]||r)}))})})}function getStyleTarget(e){var t=closestAttrValue(e,"ic-target");return t&&0==t.indexOf("this.style.")?t.substr(11):null}function getAttrTarget(e){var t=closestAttrValue(e,"ic-target");return t&&0==t.indexOf("this.")?t.substr(5):null}function fireICRequest(e,t){var r=e=$(e);e.is(getICAttributeSelector("ic-src"))||void 0!=getICAttribute(e,"ic-action")||(e=e.closest(getICAttributeSelector("ic-src")));var n=closestAttrValue(e,"ic-confirm");if((!n||confirm(n))&&("true"!=closestAttrValue(e,"ic-disable-when-doc-hidden")||!document.hidden)&&("true"!=closestAttrValue(e,"ic-disable-when-doc-inactive")||document.hasFocus())&&e.length>0){var i=uuid();e.data("ic-event-id",i);var o=function(){if(1!=e.data("ic-request-in-flight")){if(e.data("ic-event-id")==i){var n=getStyleTarget(e),s=n?null:getAttrTarget(e),c=verbFor(e),a=getICAttribute(e,"ic-src");if(a){var l=t||function(t){n?e.css(n,t):s?e.attr(s,t):(processICResponse(t,e,!1,a),"GET"!=c&&refreshDependencies(getICAttribute(e,"ic-src"),e))},u=getParametersForElement(c,e,r);u&&handleRemoteRequest(e,c,a,u,l)}maybeInvokeLocalAction(e,"")}}else e.data("ic-next-request",{req:o})},s=closestAttrValue(e,"ic-trigger-delay");s?setTimeout(o,parseInterval(s)):o()}}function maybeInvokeLocalAction(e,t){var r=getICAttribute(e,"ic"+t+"-action");r&&invokeLocalAction(e,r,t)}function invokeLocalAction(e,t,r){var n=closestAttrValue(e,"ic"+r+"-action-target");null===n&&""!==r&&(n=closestAttrValue(e,"ic-action-target"));var i=null;i=n?getTargetImpl(e,"ic-action-target"):getTarget(e);var o=t.split(";"),s=[],c=0;$.each(o,function(e,t){var r=$.trim(t),n=r,o=[];r.indexOf(":")>0&&(n=r.substr(0,r.indexOf(":")),o=computeArgs(r.substr(r.indexOf(":")+1,r.length))),""==n||("delay"==n?(null==c&&(c=0),c+=parseInterval(o[0]+"")):(null==c&&(c=420),s.push([c,makeApplyAction(i,n,o)]),c=null))}),c=0,$.each(s,function(e,t){c+=t[0],setTimeout(t[1],c)})}function computeArgs(args){try{return eval("["+args+"]")}catch(e){return[$.trim(args)]}}function makeApplyAction(e,t,r){return function(){var n=e[t]||window[t];n?n.apply(e,r):log(e,"Action "+t+" was not found","ERROR")}}function newIntercoolerHistory(e,t,r,n){function i(){for(var t=[],i=0;i<e.length;i++)0==e.key(i).indexOf(u)&&t.push(e.key(i));for(var o=0;o<t.length;o++)e.removeItem(t[o]);e.removeItem(l),d={slotLimit:r,historyVersion:n,lruList:[]}}function o(t){var r=d.lruList,n=r.indexOf(t),i=a($("body"));if(n>=0)log(i,"URL found in LRU list, moving to end","INFO"),r.splice(n,1),r.push(t);else if(log(i,"URL not found in LRU list, adding","INFO"),r.push(t),r.length>d.slotLimit){var o=r.shift();log(i,"History overflow, removing local history for "+o,"INFO"),e.removeItem(u+o)}return e.setItem(l,JSON.stringify(d)),r}function s(t,n,s,c){var l={url:s,id:u+s,content:t,yOffset:n,timestamp:(new Date).getTime(),title:c};return o(s),function(t){var n=JSON.stringify(t);try{e.setItem(t.id,n)}catch(o){try{i(),e.setItem(t.id,n)}catch(e){log(a($("body")),"Unable to save intercooler history with entire history cleared, is something else eating local storage? History Limit:"+r,"ERROR")}}}(l),l}function c(t){if(null==t.onpopstate||1!=t.onpopstate["ic-on-pop-state-handler"]){var r=t.onpopstate;t.onpopstate=function(t){triggerEvent(a($("body")),"handle.onpopstate.ic"),function(t){var r=t.state;if(r&&r["ic-id"]){var n=JSON.parse(e.getItem(r["ic-id"]));if(n)return processICResponse(n.content,a($("body")),!0),n.yOffset&&setTimeout(function(){window.scrollTo(0,n.yOffset)},100),n.title&&(document.title=n.title),!0;$.get(currentUrl(),{"ic-restore-history":!0},function(e,t){var r=createDocument(e),n=a(r).html();processICResponse(n,a($("body")),!0)})}return!1}(t)||r&&r(t),triggerEvent(a($("body")),"pageLoad.ic")},t.onpopstate["ic-on-pop-state-handler"]=!0}}function a(e){var t=e.find(getICAttributeSelector("ic-history-elt"));return t.length>0?t:e}var l="ic-history-support",u="ic-hist-elt-",d=JSON.parse(e.getItem(l)),f=null;return function(e){return null==e||e.slotLimit!=r||e.historyVersion!=n||null==e.lruList}(d)&&(log(a($("body")),"Intercooler History configuration changed, clearing history","INFO"),i()),null==d&&(d={slotLimit:r,historyVersion:n,lruList:[]}),{clearHistory:i,updateHistory:function(){f&&(function(e,r,n,i,o){var c=s(n,i,r,o);t.replaceState({"ic-id":c.id},"","");var l=a($("body")),u=s(l.html(),window.pageYOffset,e,document.title);t.pushState({"ic-id":u.id},"",e),triggerEvent(l,"pushUrl.ic",[l,u])}(f.newUrl,currentUrl(),f.oldHtml,f.yOffset,f.oldTitle),f=null)},addPopStateHandler:c,snapshotForHistory:function(e,t){var r=a($("body"));triggerEvent(r,"beforeHistorySnapshot.ic",[r]),f={newUrl:e,oldHtml:r.html(),yOffset:window.pageYOffset,oldTitle:t}},_internal:{addPopStateHandler:c,supportData:function(){return d},dumpLocalStorage:function(){var t="",r=[];for(var n in e)r.push(n);r.sort();var i=0;for(var o in r){var s=2*e[r[o]].length;i+=s,t+=r[o]+"="+(s/1024/1024).toFixed(2)+" MB\n"}return t+"\nTOTAL LOCAL STORAGE: "+(i/1024/1024).toFixed(2)+" MB"},updateLRUList:o}}}function getSlotLimit(){return 20}function refresh(e){return"string"==typeof e||e instanceof String?refreshDependencies(e):fireICRequest(e),Intercooler}function init(){var e=$("body");processNodes(e),fireReadyStuff(e),_history&&_history.addPopStateHandler(window),$.zepto&&($("body").data("zeptoDataTest",{}),"string"==typeof $("body").data("zeptoDataTest")&&log(null,"!!!! Please include the data module with Zepto!  Intercooler requires full data support to function !!!!","ERROR"))}"undefined"!=typeof Zepto&&null==$&&(window.$=Zepto);var USE_DATA="true"==$('meta[name="intercoolerjs:use-data-prefix"]').attr("content"),USE_ACTUAL_HTTP_METHOD="true"==$('meta[name="intercoolerjs:use-actual-http-method"]').attr("content"),_MACROS=$.map(["ic-get-from","ic-post-to","ic-put-to","ic-patch-to","ic-delete-from","ic-style-src","ic-attr-src","ic-prepend-from","ic-append-from","ic-action"],function(e){return fixICAttributeName(e)}),_scrollHandler=null,_UUID=1,_readyHandlers=[],_isDependentFunction=function(e,t){if(!e||!t)return!1;var r=e.split(/[\?#]/,1)[0].split("/").filter(function(e){return""!=e}),n=t.split(/[\?#]/,1)[0].split("/").filter(function(e){return""!=e});return""!=r&&""!=n&&(n.slice(0,r.length).join("/")==r.join("/")||r.slice(0,n.length).join("/")==n.join("/"))},_history=null;try{_history=newIntercoolerHistory(localStorage,window.history,20,.1)}catch(e){log($("body"),"Could not initialize history","WARN")}return $.ajaxTransport&&$.ajaxTransport("text",function(e,t){if("#"==t.url[0]){var r=fixICAttributeName("ic-local-"),n=$(t.url),i=[],o=200,s="OK";n.each(function(e,t){$.each(t.attributes,function(e,t){if(t.name.substr(0,r.length)==r){var n=t.name.substring(r.length);if("status"==n){var c=t.value.match(/(\d+)\s?(.*)/);null!=c?(o=c[1],s=c[2]):(o="500",s="Attribute Error")}else i.push(n+": "+t.value)}})});var c=n.length>0?n.html():"";return{send:function(e,t){t(o,s,{html:c},i.join("\n"))},abort:function(){}}}return null}),$(function(){init()}),{refresh:refresh,history:_history,triggerRequest:fireICRequest,processNodes:processNodes,closestAttrValue:closestAttrValue,verbFor:verbFor,isDependent:isDependent,getTarget:getTarget,processHeaders:processHeaders,startPolling:startPolling,cancelPolling:cancelPolling,setIsDependentFunction:function(e){_isDependentFunction=e},ready:function(e){_readyHandlers.push(e)},_internal:{init:init,replaceOrAddMethod:replaceOrAddMethod,initEventSource:function(e,t){return new EventSource(e,{withCredentials:t})},globalEval:globalEval,getLocalURL:getLocalURL}}}();return Intercooler});